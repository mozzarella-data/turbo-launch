<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QOZ Concept Widget — Tideline-style demo</title>
  <style>
    :root{
      --bg:#070b18;
      --card:#0f1733;
      --card2:#0c132b;
      --line:#23315f;
      --text:#eaf0ff;
      --muted:#93a6d6;
      --good:#2ee59d;
      --bad:#ff6b6b;
      --warn:#ffd166;
      --accent:#3d5afe;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(61,90,254,.25), transparent 60%),
                  radial-gradient(900px 600px at 90% 0%, rgba(46,229,157,.12), transparent 55%),
                  linear-gradient(180deg, #050815, var(--bg) 45%, #050815);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:20px 18px 26px}
    header{display:flex;justify-content:space-between;gap:14px;flex-wrap:wrap;align-items:flex-start}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin:6px 0 0;color:var(--muted);font-size:12.8px;max-width:900px;line-height:1.4}
    .pillbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:2px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(35,49,95,.9);
      background:rgba(12,19,43,.55);
      color:#cfe0ff;font-size:12px;
      user-select:none;
    }

    .cols{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .cols{grid-template-columns:1fr}
    }

    .card{
      background:rgba(15,23,51,.92);
      border:1px solid rgba(35,49,95,.9);
      border-radius:14px;
      padding:14px;
    }
    .card h2{margin:0 0 8px;font-size:13px;color:#cfe0ff;font-weight:750}
    .card .hint{color:var(--muted);font-size:12px;line-height:1.4;margin-bottom:12px}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 600px){ .grid2{grid-template-columns:1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select{
      width:100%;
      padding:10px 11px;
      border-radius:10px;
      border:1px solid rgba(35,49,95,.9);
      background:#08102a;
      color:var(--text);
      outline:none;
    }
    input:focus,select:focus{border-color:rgba(61,90,254,.95)}
    .row{margin-top:10px}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      cursor:pointer;
      border:none;
      border-radius:10px;
      padding:10px 12px;
      font-weight:750;
      background:#22305d;color:var(--text);
    }
    button.primary{background:var(--accent)}
    button.ghost{background:transparent;border:1px solid rgba(35,49,95,.9)}
    button.small{padding:8px 10px;font-size:12px}

    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    @media (max-width: 600px){ .kpis{grid-template-columns:1fr} }
    .kpi{
      padding:12px;border-radius:12px;
      border:1px solid rgba(35,49,95,.9);
      background:rgba(12,19,43,.55);
    }
    .kpi .lbl{font-size:12px;color:var(--muted)}
    .kpi .val{margin-top:6px;font-size:18px;font-weight:850}
    .kpi .subval{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.35}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}

    .timeline{
      margin-top:12px;
      border-radius:12px;
      border:1px solid rgba(35,49,95,.9);
      background:rgba(12,19,43,.55);
      padding:12px;
    }
    .trow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .tstep{
      flex:1;
      min-width:180px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(35,49,95,.75);
      background:rgba(8,16,42,.55);
    }
    .tstep .t{font-size:12px;color:var(--muted)}
    .tstep .b{margin-top:4px;font-weight:850}
    .tstep .s{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.35}

    .callout{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(35,49,95,.9);
      background:rgba(8,16,42,.55);
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .callout strong{color:#cfe0ff}
    details{margin-top:12px}
    summary{cursor:pointer;color:#cfe0ff;font-weight:750}
    .fine{margin-top:8px;color:var(--muted);font-size:12px;line-height:1.45}
    .minihr{height:1px;background:rgba(35,49,95,.75);margin:12px 0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>QOZ concept widget (generic) + Pepper Tree example (specific)</h1>
        <div class="sub">
          This is an <b>education / scenario</b> tool. It’s designed to be <b>rule-accurate</b> at a high level and cash-flow aware,
          but it’s <b>not tax advice</b>. It shows the “killer moment”: <b>pay tax now</b> vs <b>defer + potentially exclude new appreciation after 10 years</b>.
        </div>
      </div>
      <div class="pillbar">
        <span class="pill">Desktop: side-by-side</span>
        <span class="pill">Mobile: stacked</span>
        <span class="pill">Prefilled with favorable demo numbers</span>
      </div>
    </header>

    <div class="cols">
      <!-- LEFT: QOZ Decision Engine -->
      <section class="card" id="leftCard">
        <h2>1) QOZ decision engine (generic)</h2>
        <div class="hint">
          Use this panel without mentioning any specific deal. It answers: “Should I even consider a QOZ deferral + 10-year hold strategy?”
        </div>

        <div class="grid2">
          <div>
            <label>Eligible capital gain (not sale price) ($)</label>
            <input id="gain" type="number" min="0" step="1000" value="4000000">
          </div>
          <div>
            <label>Amount invested into QOF ($)</label>
            <input id="qofInvest" type="number" min="0" step="1000" value="4000000">
          </div>

          <div>
            <label>Federal LTCG rate (%)</label>
            <input id="fedRate" type="number" min="0" max="60" step="0.1" value="20">
          </div>
          <div>
            <label>NIIT (%)</label>
            <input id="niitRate" type="number" min="0" max="10" step="0.1" value="3.8">
          </div>

          <div>
            <label>State tax rate (%)</label>
            <input id="stateRate" type="number" min="0" max="20" step="0.1" value="13.3">
          </div>
          <div>
            <label>State conforms to QOZ?</label>
            <select id="stateConform">
              <option value="no" selected>No (e.g., CA does not conform)</option>
              <option value="yes">Yes (assume conforms)</option>
            </select>
          </div>

          <div>
            <label>Hold period (years)</label>
            <input id="holdYears" type="number" min="1" max="20" step="1" value="10">
          </div>
          <div>
            <label>Assumed annual return (for generic comparison) (%)</label>
            <input id="assumedReturn" type="number" min="-50" max="50" step="0.1" value="10">
          </div>

          <div>
            <label>Pay deferred tax in 2026 using…</label>
            <select id="payDeferredFrom">
              <option value="outside" selected>Outside cash (most favorable)</option>
              <option value="sell">Sell part of the investment (less favorable)</option>
            </select>
          </div>
          <div>
            <label>Tax on NON-QOZ appreciation at exit?</label>
            <input id="exitTaxRate" type="number" min="0" max="60" step="0.1" value="23.8">
          </div>
        </div>

        <div class="btnrow">
          <button class="primary" id="recalc">Recalculate</button>
          <button class="ghost" id="resetDemo">Reset to favorable demo</button>
          <button class="small" id="copyLink">Copy shareable link</button>
        </div>

        <div class="timeline" aria-label="timeline strip">
          <div class="trow">
            <div class="tstep">
              <div class="t">Today</div>
              <div class="b">Choose a path</div>
              <div class="s">Either pay tax now, or invest eligible gain into a QOF (within required timelines).</div>
            </div>
            <div class="tstep">
              <div class="t">12/31/2026</div>
              <div class="b">Deferred gain tax is due</div>
              <div class="s">Deferral is not forever under the original regime. You still owe tax on the original deferred gain.</div>
            </div>
            <div class="tstep">
              <div class="t">Year <span id="tyHold">10</span></div>
              <div class="b">Exit</div>
              <div class="s">If held long enough, post-investment appreciation inside the QOZ investment may be excluded federally (concept model).</div>
            </div>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="lbl">Do nothing (pay tax now) — ending after-tax value</div>
            <div class="val bad" id="noQozEnd">$—</div>
            <div class="subval" id="noQozExplain">—</div>
          </div>
          <div class="kpi">
            <div class="lbl">Use QOZ (defer + possible tax-free appreciation) — ending after-tax value</div>
            <div class="val good" id="qozEnd">$—</div>
            <div class="subval" id="qozExplain">—</div>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="lbl">Deferred original gain tax due by ~2026 (concept)</div>
            <div class="val warn" id="deferredTax">$—</div>
            <div class="subval" id="deferredExplain">—</div>
          </div>
          <div class="kpi">
            <div class="lbl">Difference (QOZ − do nothing)</div>
            <div class="val" id="delta">$—</div>
            <div class="subval" id="deltaExplain">—</div>
          </div>
        </div>

        <div class="callout">
          <strong>Reality checks:</strong><br>
          • This model assumes a clean 10-year hold for the QOZ exclusion concept.<br>
          • “State conforms” matters. Example: CA generally doesn’t conform, so state taxes may still apply.<br>
          • This is a scenario tool, not a substitute for your CPA.
        </div>

        <details>
          <summary>Assumptions (what this model does / doesn’t do)</summary>
          <div class="fine">
            <ul>
              <li>It compares two paths using cash-flow logic: invest after paying tax now vs invest pre-tax and pay deferred tax later.</li>
              <li>It treats QOZ “tax-free appreciation” as applying to <i>post-investment appreciation</i> (concept only).</li>
              <li>It does <b>not</b> try to model depreciation, refinancing, K-1 timing, AMT, loss harvesting, or step-up edge cases.</li>
            </ul>
          </div>
        </details>
      </section>

      <!-- RIGHT: Pepper Tree Example -->
      <section class="card" id="rightCard">
        <h2>2) Pepper Tree Lofts example (specific deal overlay)</h2>
        <div class="hint">
          This panel assumes a QOZ-eligible fund structure and uses Lev’s headline numbers as a <b>projection</b>:
          <span class="mono">2.5x equity multiple</span> over 10 years, <span class="mono">~8% cash-on-cash</span> average, <span class="mono">~13% IRR</span> (headline).
        </div>

        <div class="grid2">
          <div>
            <label>Allocate to Pepper Tree ($)</label>
            <input id="pepAlloc" type="number" min="0" step="1000" value="1000000">
          </div>
          <div>
            <label>Hold (years) — locked to match example</label>
            <input id="pepHold" type="number" min="1" max="20" step="1" value="10" disabled>
          </div>

          <div>
            <label>Equity multiple (10-yr) — projection</label>
            <input id="pepMultiple" type="number" min="0" step="0.01" value="2.5">
          </div>
          <div>
            <label>Avg cash-on-cash (annual) — projection (%)</label>
            <input id="pepCoC" type="number" min="-50" max="50" step="0.1" value="8">
          </div>

          <div>
            <label>Preferred return (pref) (%)</label>
            <input id="pepPref" type="number" min="0" max="30" step="0.1" value="8">
          </div>
          <div>
            <label>Promote (%)</label>
            <input id="pepPromote" type="number" min="0" max="50" step="0.1" value="20">
          </div>
        </div>

        <div class="minihr"></div>

        <div class="kpis">
          <div class="kpi">
            <div class="lbl">Projected ending value (allocation × multiple)</div>
            <div class="val good" id="pepEnd">$—</div>
            <div class="subval" id="pepEndExplain">—</div>
          </div>
          <div class="kpi">
            <div class="lbl">Projected appreciation</div>
            <div class="val" id="pepGain">$—</div>
            <div class="subval" id="pepGainExplain">—</div>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="lbl">If held 10+ years in a QOZ, federal tax on this appreciation may be excluded (concept)</div>
            <div class="val warn" id="pepTaxSaved">$—</div>
            <div class="subval" id="pepTaxSavedExplain">—</div>
          </div>
          <div class="kpi">
            <div class="lbl">Reminder: deferred original gain tax still comes due ~2026</div>
            <div class="val warn" id="pepDeferredReminder">$—</div>
            <div class="subval" id="pepDeferredReminderExplain">—</div>
          </div>
        </div>

        <div class="callout">
          <strong>How to use this with an RIA/CPA:</strong><br>
          1) Left panel answers “QOZ as a strategy.”<br>
          2) Right panel shows “one example deal outcome if you’re doing QOZ anyway.”<br>
          Keep them separate so you don’t over-claim.
        </div>

        <details>
          <summary>Optional: add a “minimum check” for demo</summary>
          <div class="fine">
            Minimum investment mentioned: <span class="mono">$50,000</span> (demo uses $1,000,000). If allocation is below minimum, we’ll flag it.
          </div>
        </details>

        <div class="footer" id="minFlag" style="margin-top:10px;"></div>
      </section>
    </div>

    <div class="callout" style="margin-top:14px">
      <strong>Disclosures (keep this):</strong><br>
      • This page is a simplified educational model. It does not account for your full tax picture, deal documents, fees, K-1 timing, or state-specific rules beyond a simple conform/non-conform toggle.<br>
      • Projections are not guarantees. Always confirm with a CPA and the fund’s offering documents.
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  function fmtMoney(x){
    if (!isFinite(x)) return "$—";
    const s = Math.round(x).toString();
    return "$" + s.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

  function parseNum(el, fallback=0){
    const v = Number(el.value);
    return isFinite(v) ? v : fallback;
  }

  // Core model:
  // Path A (No QOZ): pay tax now on gain, invest remaining, grow, pay exit tax on appreciation.
  // Path B (QOZ): invest pre-tax gain, grow. Deferred original gain tax due in 2026.
  // If hold >=10, treat appreciation as tax-free federally (concept). State conformity toggle affects whether "tax-free" applies to state.
  // If deferred tax is paid by selling assets, reduce invested base in 2026 by that amount.

  function calc(){
    const gain = Math.max(0, parseNum($("gain")));
    const qofInvest = Math.max(0, parseNum($("qofInvest")));
    const fed = clamp(parseNum($("fedRate")),0,80)/100;
    const niit = clamp(parseNum($("niitRate")),0,20)/100;
    const state = clamp(parseNum($("stateRate")),0,30)/100;
    const stateConform = $("stateConform").value; // yes/no
    const hold = clamp(parseNum($("holdYears")),1,30);
    const r = clamp(parseNum($("assumedReturn")),-99,99)/100;
    const exitTax = clamp(parseNum($("exitTaxRate")),0,80)/100;
    const payDeferredFrom = $("payDeferredFrom").value; // outside/sell

    $("tyHold").textContent = hold;

    const totalTaxRateNow = fed + niit + state; // simplified "combined"
    const eligibleToInvest = Math.min(gain, qofInvest);

    // Deferred tax is on the deferred gain amount (eligibleToInvest assumed deferred).
    // State conformity: if state doesn't conform, state tax is NOT deferred/excluded; we treat it as still due (simplified).
    const deferredFedNiiRate = fed + niit;
    const deferredStateRate = state; // only deferred if state conforms
    const deferredTaxRate = deferredFedNiiRate + (stateConform === "yes" ? deferredStateRate : 0);

    const deferredTax = eligibleToInvest * deferredTaxRate;

    // Path A: pay full combined tax now on the gain (this is what people intuitively compare).
    const payNowTax = gain * totalTaxRateNow;
    const investA = gain - payNowTax;
    const endA_gross = investA * Math.pow(1 + r, hold);

    // Tax on appreciation at exit for A (simplified).
    const appreciationA = Math.max(0, endA_gross - investA);
    const exitTaxA = appreciationA * exitTax;
    const endA = endA_gross - exitTaxA;

    // Path B: invest eligibleToInvest pre-tax.
    // If investing less than gain, remaining gain is not in QOZ; for simplicity we ignore it (user can set equal).
    let investB = eligibleToInvest;

    // Grow until 2026 and then pay deferred tax.
    // Approx years to 12/31/2026 from "today" is unknown; use a simple 2-year default if hold>=2, else 1.
    // We keep it "concept" and don’t anchor to today’s date to avoid false precision.
    const yearsToTax = Math.min(2, hold); // simple
    const yearsAfterTax = hold - yearsToTax;

    const valueAtTaxTime = investB * Math.pow(1 + r, yearsToTax);

    let valueAfterPayingDeferred = valueAtTaxTime;
    let paidDeferredFromInvestment = 0;

    if (payDeferredFrom === "sell"){
      // Pay deferred tax by reducing investment value.
      paidDeferredFromInvestment = Math.min(deferredTax, valueAfterPayingDeferred);
      valueAfterPayingDeferred -= paidDeferredFromInvestment;
    }
    // Then continue growth to hold horizon
    const endB_gross = valueAfterPayingDeferred * Math.pow(1 + r, yearsAfterTax);

    // Tax on B appreciation:
    // If hold >= 10: federal on appreciation assumed excluded; state depends on conformity.
    // We'll compute an "effective tax on appreciation" for B.
    const appreciationB = Math.max(0, endB_gross - valueAfterPayingDeferred);
    let appreciationTaxRateB = 0;

    if (hold < 10){
      // Not long enough: treat like normal exit tax (simplified).
      appreciationTaxRateB = exitTax;
    } else {
      // 10+ years: federal excluded (concept); state excluded only if conforms.
      // We approximate state component by using stateRate as a portion of exitTax if user wants more detail,
      // but simplest: if state doesn't conform, tax appreciation at state rate only.
      appreciationTaxRateB = (stateConform === "yes") ? 0 : state;
    }

    const exitTaxB = appreciationB * appreciationTaxRateB;
    const endB = endB_gross - exitTaxB;

    // Display
    $("noQozEnd").textContent = fmtMoney(endA);
    $("qozEnd").textContent = fmtMoney(endB);

    $("noQozExplain").textContent =
      `Investable today: ${fmtMoney(investA)} (after paying ~${(totalTaxRateNow*100).toFixed(1)}% tax now). ` +
      `Exit tax assumed on appreciation at ${(exitTax*100).toFixed(1)}%.`;

    const stateNote = (stateConform === "yes")
      ? "State assumed to conform (simplified)."
      : "State assumed NOT to conform (e.g., CA) — state tax may still apply.";

    $("qozExplain").textContent =
      `Investable today: ${fmtMoney(investB)} (pre-tax). Deferred tax due ~2026: ${fmtMoney(deferredTax)}. ` +
      (hold >= 10 ? `At ${hold} years, appreciation tax modeled as: ${(appreciationTaxRateB*100).toFixed(1)}% (concept). ` : `At ${hold} years, appreciation taxed normally (simplified). `) +
      stateNote;

    $("deferredTax").textContent = fmtMoney(deferredTax);
    $("deferredExplain").textContent =
      `Deferred tax modeled on ${fmtMoney(eligibleToInvest)} of gain at ${(deferredTaxRate*100).toFixed(1)}%. ` +
      (payDeferredFrom === "outside"
        ? "Assumes you pay this from outside cash (most favorable)."
        : `Assumes you sell ~${fmtMoney(paidDeferredFromInvestment)} of the investment to pay it (less favorable).`);

    const delta = endB - endA;
    $("delta").textContent = fmtMoney(delta);
    $("delta").className = "val " + (delta >= 0 ? "good" : "bad");
    $("deltaExplain").textContent =
      delta >= 0
        ? "In this scenario, QOZ path ends higher primarily due to larger starting principal + reduced tax on appreciation (if 10+ yrs)."
        : "In this scenario, QOZ path ends lower (often happens if you must sell to pay deferred tax, or if hold < 10 years).";

    // Right panel (Pepper Tree overlay)
    const alloc = Math.max(0, parseNum($("pepAlloc")));
    const multiple = Math.max(0, parseNum($("pepMultiple")));
    const pepHold = 10; // locked
    $("pepHold").value = pepHold;

    const pepEnd = alloc * multiple;
    const pepGain = Math.max(0, pepEnd - alloc);

    $("pepEnd").textContent = fmtMoney(pepEnd);
    $("pepEndExplain").textContent = `${fmtMoney(alloc)} × ${multiple.toFixed(2)}x = ${fmtMoney(pepEnd)} (projection).`;

    $("pepGain").textContent = fmtMoney(pepGain);
    $("pepGainExplain").textContent = `Projected appreciation: ${fmtMoney(pepEnd)} − ${fmtMoney(alloc)} = ${fmtMoney(pepGain)}.`;

    // Tax saved on Pepper Tree appreciation under QOZ concept:
    // Federal excluded; state depends on conformity setting from left panel.
    const pepAppTaxRate = (stateConform === "yes") ? 0 : state;
    const pepTaxSaved = pepGain * (fed + niit + (stateConform === "yes" ? state : 0)); // what would have been paid if fully taxable
    const pepTaxStill = pepGain * pepAppTaxRate;

    $("pepTaxSaved").textContent = fmtMoney(pepTaxSaved);
    $("pepTaxSavedExplain").textContent =
      `Concept: if fully taxable, appreciation might face ~${((fed+niit+state)*100).toFixed(1)}% combined. ` +
      `With 10+yr QOZ assumption, modeled appreciation tax: ${(pepAppTaxRate*100).toFixed(1)}% (state only if non-conforming).`;

    $("pepDeferredReminder").textContent = fmtMoney(deferredTax);
    $("pepDeferredReminderExplain").textContent =
      `This is the “you still owe it” number — deferred original gain tax modeled due ~2026.`;

    // Minimum flag
    const min = 50000;
    const minFlag = $("minFlag");
    if (alloc > 0 && alloc < min){
      minFlag.textContent = `Heads up: allocation ${fmtMoney(alloc)} is below the stated $50,000 minimum (demo flag).`;
      minFlag.style.color = "var(--warn)";
    } else {
      minFlag.textContent = "";
    }

    // Persist params in URL (for share links)
    syncToUrl();
  }

  function resetDemo(){
    $("gain").value = 4000000;
    $("qofInvest").value = 4000000;
    $("fedRate").value = 20;
    $("niitRate").value = 3.8;
    $("stateRate").value = 13.3;
    $("stateConform").value = "no";
    $("holdYears").value = 10;
    $("assumedReturn").value = 10;
    $("payDeferredFrom").value = "outside";
    $("exitTaxRate").value = 23.8;

    $("pepAlloc").value = 1000000;
    $("pepMultiple").value = 2.5;
    $("pepCoC").value = 8;
    $("pepPref").value = 8;
    $("pepPromote").value = 20;

    calc();
  }

  function getParams(){
    const p = new URLSearchParams(location.search);
    const obj = {};
    for (const [k,v] of p.entries()) obj[k]=v;
    return obj;
  }

  function applyFromUrl(){
    const p = getParams();
    const map = {
      gain:"gain", qofInvest:"qofInvest", fed:"fedRate", niit:"niitRate", state:"stateRate",
      conform:"stateConform", hold:"holdYears", r:"assumedReturn", pay:"payDeferredFrom", exit:"exitTaxRate",
      alloc:"pepAlloc", mult:"pepMultiple"
    };
    Object.keys(map).forEach(key=>{
      if (p[key] != null && $(map[key])) $(map[key]).value = p[key];
    });
  }

  function syncToUrl(){
    const p = new URLSearchParams();
    p.set("gain", $("gain").value);
    p.set("qofInvest", $("qofInvest").value);
    p.set("fed", $("fedRate").value);
    p.set("niit", $("niitRate").value);
    p.set("state", $("stateRate").value);
    p.set("conform", $("stateConform").value);
    p.set("hold", $("holdYears").value);
    p.set("r", $("assumedReturn").value);
    p.set("pay", $("payDeferredFrom").value);
    p.set("exit", $("exitTaxRate").value);
    p.set("alloc", $("pepAlloc").value);
    p.set("mult", $("pepMultiple").value);

    const newUrl = location.pathname + "?" + p.toString();
    history.replaceState(null, "", newUrl);
  }

  async function copyLink(){
    try{
      const url = location.href;
      await navigator.clipboard.writeText(url);
      alert("Copied link with current inputs.");
    }catch(e){
      alert("Couldn’t copy automatically. You can manually copy the URL in the address bar.");
    }
  }

  // Wire up
  $("recalc").addEventListener("click", calc);
  $("resetDemo").addEventListener("click", resetDemo);
  $("copyLink").addEventListener("click", copyLink);

  // Recalc on input changes (nice UX)
  const inputs = ["gain","qofInvest","fedRate","niitRate","stateRate","stateConform","holdYears","assumedReturn","payDeferredFrom","exitTaxRate","pepAlloc","pepMultiple"];
  inputs.forEach(id=>{
    $(id).addEventListener("input", ()=>calc());
    $(id).addEventListener("change", ()=>calc());
  });

  // Init
  applyFromUrl();
  calc();
})();
</script>
</body>
</html>
